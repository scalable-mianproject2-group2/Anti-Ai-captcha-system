<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Animal Sound CAPTCHA</title>

    <!-- font + jQuery -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        :root {
            --bg: #eef2ff;
            --card: #fff;
            --primary-start: #7b3cff;
            --primary-end: #5b1fd9;
            --accent: #6f2cff;
            --success: #16a34a;
            --danger: #ef4444;
            --muted: #6b7280;
            --radius: 14px;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(180deg, #f7f9ff, #eef2ff);
            color: #0f172a;
        }

        .wrap {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 36px;
        }

        .card {
            width: min(520px, 96%);
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(16, 24, 40, 0.08);
            padding: 18px 20px;
            position: relative;
            overflow: visible;
        }

        /* small top-right logo */
        .card .logo {
            position: absolute;
            right: 18px;
            top: -26px;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 18px rgba(99, 102, 241, 0.16);
            border: 4px solid rgba(255, 255, 255, 0.8);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.2));
        }

        .card h1 {
            margin: 0 0 8px;
            margin-bottom: 6px;
            font-size: 20px;
            font-weight: 700;
            color: #08112b;
        }

        .sub {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .audio-wrap {
            margin: 10px 0 12px;
            padding: 10px;
            border-radius: 12px;
        }

        label {
            margin-top: 8px;
            margin-bottom: 6px;
        }

        audio {
            width: 100%;
            outline: none;
            border-radius: 8px;
        }

        label {
            display: block;
            margin-top: 6px;
            color: var(--muted);
            font-weight: 600;
        }

        .next-row {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
        }

        select {
            width: 100%;
            padding: 12px 14px;
            margin-top: 8px;
            margin-bottom: 8px;
            border-radius: 10px;
            border: 1px solid #e6e9f2;
            font-size: 15px;
            background: white;
            box-shadow: inset 0 1px 0 rgba(16, 24, 40, 0.02);
            -webkit-appearance: none;
            appearance: none;
        }

        .btn {
            display: inline-block;
            width: 100%;
            padding: 12px 14px;
            margin-top: 10px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            color: white;
            font-size: 16px;
            background: linear-gradient(90deg, var(--primary-start), var(--primary-end));
            box-shadow: 0 8px 24px rgba(91, 31, 217, 0.14);
            transition: transform .12s ease, box-shadow .12s ease;
        }

        .btn:active {
            transform: translateY(1px) scale(.998);
            box-shadow: 0 6px 16px rgba(91, 31, 217, 0.12);
        }

        .muted-note {
            font-size: 13px;
            color: var(--muted);
            margin-top: 10px;
            text-align: center;
        }

        .next-btn {
            background: #2eae4a;
            /* green */
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            width: 110px;
            /* small width */
            box-shadow: 0 8px 20px rgba(46, 174, 74, 0.12);
        }

        .next-btn:hover {
            background: #3e8e41;
            transform: translateY(-1px);
        }

        /* Modal overlay + dialog (hidden by default) */
        #modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.45);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal {
            width: min(420px, 92%);
            background: #ffffff;
            border-radius: 14px;
            padding: 18px;
            box-shadow: 0 18px 40px rgba(2, 6, 23, 0.18);
            transform: translateY(8px) scale(.98);
            opacity: 0;
            transition: all 180ms cubic-bezier(.2, .9, .2, 1);
        }

        #modal-overlay.show .modal {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal h3 {
            margin: 0 0 8px;
            font-size: 18px;
        }

        .modal p {
            margin: 0;
            color: var(--muted);
            font-size: 14px;
            white-space: pre-line;
        }

        .modal .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            margin-top: 12px;
            font-weight: 700;
        }

        .badge.success {
            background: rgba(22, 163, 74, 0.12);
            color: var(--success);
        }

        .badge.fail {
            background: rgba(239, 68, 68, 0.08);
            color: var(--danger);
        }

        .modal .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            justify-content: flex-end;
        }

        .modal .ok-btn {
            padding: 10px 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background: linear-gradient(90deg, #14b8a6, #0ea5a0);
            color: white;
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.12);
        }

        .modal .close-btn {
            background: transparent;
            border: none;
            color: var(--muted);
            font-weight: 700;
            cursor: pointer;
        }


        /* small responsive tweak */
        @media (max-width:420px) {
            .card {
                padding: 18px;
                border-radius: 12px;
            }

            .logo {
                width: 48px;
                height: 48px;
                right: 14px;
                top: -18px;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <!-- logo uses the local uploaded image path; system will transform to URL when serving -->
            <div class="logo">
                <img src="{{ url_for('static', filename='images/audio.jpg') }}" alt="logo"
                    style="width:100%;height:100%;object-fit:cover;" class="logo-img">
            </div>

            <h1>Animal Sound CAPTCHA</h1>
            <div class="sub">Listen to the audio and select the correct animal from the dropdown.</div>

            <div class="audio-wrap">
                <audio id="audio-player" controls>
                    <source src="{{ url_for('send_audio', filename=audio_file) }}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
            <div class="next-row">
                <button id="next-btn" type="button" class="next-btn">Refresh</button>
            </div>

            <form id="captcha-form">
                <label for="dropdown">Select the animal sound:</label>
                <select id="dropdown" name="selected">
                    <option value="" disabled selected>-- choose an option --</option>
                    {% for option in options %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>

                <input type="hidden" name="ground_truth" value="{{ ground_truth }}">
                <div id="result" style="display:none;">{{ result or "" }}</div>
                <button class="btn" type="submit" id="submit-btn">Verify</button>


                <div class="muted-note">You can replay the audio and then verify.</div>
            </form>
        </div>
    </div>

    <!-- Modal overlay (hidden by default). JS toggles .show -->
    <div id="modal-overlay" aria-hidden="true" style="display:none;">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <h3 id="modal-title">Result</h3>
            <p id="modal-message" style="font-size:16px; font-weight:600;"></p>
            <div id="modal-badge" class="badge" style="display:none; margin-top:12px;"></div>
            <div class="modal-actions" style="margin-top:14px;">
                <button class="close-btn" id="modal-close">Close</button>
                <button class="ok-btn" id="modal-ok">OK</button>
            </div>
        </div>
    </div>


    <script>
        $(function () {

            $('#next-btn').on('click', function () {
                window.location.reload();   // loads new CAPTCHA
            });

            // -------- defender toast helper (AI-only) ----------
            // -------- defender toast helper (AI-only) ----------
            function showAIAlert() {
                console.log("showAIAlert() called");  // debug log

                var el = document.getElementById('ai-alert');
                if (!el) {
                    console.warn('ai-alert element not found');
                    return;
                }
                el.style.display = 'block';
            }
            // make available to defender block (second <script>)
            window.showAIAlert = showAIAlert;


            var last_seen_play_id = null;
            function pollForAudioPlay() {
                $.get("/should_play_audio", {}, function (res) {
                    try {
                        if (res && res.play && res.id && res.id !== last_seen_play_id) {
                            last_seen_play_id = res.id;

                            // mark as AI triggered so the payload will include via_ai_flag
                            window.__aiTriggered = true;

                            // send defender signal immediately
                            if (typeof sendSignalAndMaybeAlert === 'function') {
                                try { sendSignalAndMaybeAlert('ai_trigger'); } catch (e) { console.warn('defender send failed', e); }
                            }

                            // show popup locally if unverified (fast)
                            showAIAlert();

                            // Play the currently-rendered audio element (visible to user)
                           
                            var audio = document.getElementById("audio-player");
                            if (audio) {
                                // ensure file is loaded from start
                                try {
                                    audio.load();
                                    audio.currentTime = 0;
                                } catch (e) {
                                    console.warn("audio load/currentTime failed:", e);
                                }

                                // first attempt — normal play
                                audio.play().then(() => {
                                    console.log("audio.play() started from AI trigger");
                                }).catch(err => {
                                    console.warn("audio.play() blocked by autoplay policy:", err);

                                    // fallback attempt — muted autoplay (often allowed)
                                    try {
                                        audio.muted = true;
                                        audio.play().then(() => {
                                            console.log("muted autoplay succeeded; unmuting now");
                                            audio.muted = false;
                                        }).catch(e2 => {
                                            console.warn("even muted autoplay blocked — user gesture required");
                                        });
                                    } catch (e2) {
                                        console.warn("muted autoplay attempt failed:", e2);
                                    }
                                });
                            }

                        }
                    } catch (err) {
                        console.warn("pollForAudioPlay error:", err);
                    } finally {
                        setTimeout(pollForAudioPlay, 800);
                    }
                }).fail(function () { setTimeout(pollForAudioPlay, 1500); });
            }
            pollForAudioPlay();


            function showSimpleResult(resultText) {
                // resultText should be "Success" or "Failure" (or include those words)
                $('#modal-message').text(resultText);

                // style badge based on success/failure text
                var badge = $('#modal-badge');
                if ((resultText || '').toLowerCase().includes('success')) {
                    badge.removeClass('fail').addClass('success').text('✓ AI Result : Success').show();
                } else {
                    badge.removeClass('success').addClass('fail').text('✕ AI Result : Failure').show();
                }

                $('#modal-overlay').attr('aria-hidden', 'false').addClass('show').fadeIn(120);
            }


            // show/hide modal utilities
            // improved accessible show/hide modal helpers
            // Accessible modal show/hide helpers — GLOBAL so defender code can call them
            function showModal(message) {
                const overlay = document.getElementById('modal-overlay');
                const content = overlay ? overlay.querySelector('.modal') : null;
                const ok = document.getElementById('modal-ok');
                const close = document.getElementById('modal-close');
                const text = document.getElementById('modal-message');

                if (!overlay || !content || !ok || !text) {
                    console.warn('Modal elements missing');
                    return;
                }

                // set message text
                text.textContent = message;

                // show overlay and mark accessible
                overlay.style.display = 'block';
                overlay.classList.add('show');
                overlay.setAttribute('aria-hidden', 'false');

                // make content focusable and move focus
                if (!content.hasAttribute('tabindex')) content.setAttribute('tabindex', '-1');

                setTimeout(() => {
                    try { ok.focus({ preventScroll: true }); } catch (e) { ok.focus(); }
                }, 10);

                overlay._onKey = function (e) {
                    if (e.key === 'Escape') hideModal();
                };
                document.addEventListener('keydown', overlay._onKey);
            }

            function hideModal() {
                const overlay = document.getElementById('modal-overlay');
                if (!overlay) return;

                // move focus off the button before hiding to avoid the aria-hidden warning
                const ok = document.getElementById('modal-ok');
                if (document.activeElement === ok) {
                    ok.blur();
                }

                overlay.style.display = 'none';
                overlay.classList.remove('show');
                overlay.setAttribute('aria-hidden', 'true');

                if (overlay._onKey) {
                    document.removeEventListener('keydown', overlay._onKey);
                    delete overlay._onKey;
                }
            }

            // expose globally so the defender IIFE can call these
            window.showModal = showModal;
            window.hideModal = hideModal;


            // === ADD THESE RIGHT AFTER THE HELPERS ===
            document.getElementById('modal-ok').addEventListener('click', function () {
                hideModal();
            });

            document.getElementById('modal-close').addEventListener('click', function () {
                hideModal();
            });


            /* ---------- Human form submit (replace your current handler) ---------- */
            $('#captcha-form').on('submit', function (e) {
                e.preventDefault();

                var form = this;
                var formData = new FormData(form);
                // user selection (human)
                var selectedValue = $('#dropdown').val() || '';

                fetch('/check', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                }).then(function (resp) {
                    return resp.text(); // server returns rendered HTML page
                }).then(function (htmlText) {
                    // parse returned HTML to find result message if present
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(htmlText, 'text/html');

                    // find server-side result message (if present)
                    var resultMsg = '';
                    var resultEl = doc.querySelector('#result') || doc.querySelector('.result');
                    if (resultEl) {
                        resultMsg = resultEl.textContent.trim();
                    } else {
                        // fallback detection
                        if (htmlText.indexOf('✅') !== -1 || /success/i.test(htmlText)) {
                            resultMsg = '✅ Success!';
                        } else if (htmlText.indexOf('❌') !== -1 || /incorrect/i.test(htmlText)) {
                            resultMsg = '❌ Incorrect! Try again.';
                        } else {
                            resultMsg = 'Result updated';
                        }
                    }

                    
                    showModal("Human submission result: " + resultMsg, "", "", false);

                }).catch(function (err) {
                    console.error("Submit failed:", err);
                    showModal("Human submission failed.", "", "", false);
                });
            });

            // Human submission handler
            $('#captcha-form').on('submit', function (e) {
                e.preventDefault();
                var form = this;
                var formData = new FormData(form);
                var selectedValue = $('#dropdown').val() || '';

                fetch('/check', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                }).then(function (resp) {
                    return resp.text();
                }).then(function (htmlText) {
                    var parser = new DOMParser();
                    var doc = parser.parseFromString(htmlText, 'text/html');

                    // -- preferred: read a server-rendered element --
                    var resultEl = doc.querySelector('#result') || doc.querySelector('.result');
                    var resultMsg = resultEl ? resultEl.textContent.trim() : null;

                    // extract ground truth (if server rendered it back to template)
                    var groundInput = doc.querySelector('input[name="ground_truth"]');
                    var groundTruth = groundInput && groundInput.value ? groundInput.value : '';

                    // If server didn't render #result, use a safe fallback message (do NOT parse raw html)
                    if (!resultMsg) {
                        resultMsg = "Submission processed. (Reloaded view.)";
                    }

                    // For human submission we DO NOT show predicted/ground-truth details
                    showModal("Human submission result: " + resultMsg, "", "", false);

                }).catch(function (err) {
                    console.error("Submit/parse failed:", err);
                    showModal("Human submission failed.", "", "", false);
                });
            });
            // The modal close/ok buttons both simply hide the modal and leave dropdown value intact
            $('#modal-close, #modal-ok').on('click', function () {
                hideModal();
            });

            // Polling for AI results (server consumes payload once)
            var last_id = 0;
            function pollAI() {
                $.get("/ai_result", { last_id: last_id }, function (resp) {
                    if (resp.has_new) {
                        last_id = resp.id;
                        var d = resp.data;
                        var predicted = d.predicted;

                        // mark AI and notify defender immediately
                        window.__aiTriggered = true;

                        // show DEFENDER toast immediately when AI is detected
                        showAIAlert();

                        console.log("AI detected — sending defender signal");
                        if (typeof sendSignalAndMaybeAlert === 'function') sendSignalAndMaybeAlert('ai_submit');

                        // set dropdown to predicted
                        if ($('#dropdown option[value="' + predicted + '"]').length > 0) {
                            $('#dropdown').val(predicted);
                        } else {
                            $('#dropdown').append($('<option>', { value: predicted, text: predicted, 'data-temp': '1' }));
                            $('#dropdown').val(predicted);
                        }

                        // auto-submit (existing behaviour)
                        var formData = $('#captcha-form').serialize();
                        $.post("/check", formData, function (data) {
                            // show AI result modal only with success/failure (your modal code can be used here)
                            showSimpleResult(data.result === 'Success' ? 'Success' : 'Failure');
                            // showModal("AI submission result: " + aiResultLabel);

                        }).fail(function () {
                            // even if /check fails, show the defender popup based on server-side scoring
                            // (sendSignalAndMaybeAlert already requested score; but if you want, show local fallback)
                            showSimpleResult('Failure (network)');
                        });
                    }
                    setTimeout(pollAI, 1000);
                }).fail(function () {
                    setTimeout(pollAI, 2000);
                });
            }
            pollAI();
        });
    </script>


    <!-- ===== Defender UI & collector  ===== -->
    <style>
        
        #ai-alert {
            position: fixed;
            right: 18px;
            bottom: 18px;
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 18px 40px rgba(8, 10, 30, 0.12);
            padding: 14px;
            display: none;
            z-index: 9999;
            font-family: Arial, sans-serif;
        }

        #ai-alert h4 {
            margin: 0 0 6px 0;
            font-size: 16px;
            display: inline-block;
            vertical-align: middle;
        }

        #ai-alert p {
            margin: 0 0 8px 0;
            color: #555;
            font-size: 13px;
        }

        .ai-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 8px;
        }

        .ai-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        .ai-btn.verify {
            background: #2e7d32;
            color: white;
        }

        .ai-btn.dismiss {
            background: #e5e7eb;
            color: #111;
        }

        .ai-badge {
            display: inline-block;
            padding: 6px 8px;
            border-radius: 999px;
            background: #fde68a;
            color: #92400e;
            font-weight: 700;
            margin-right: 8px;
        }
    </style>

    <div id="ai-alert" role="dialog" aria-live="polite">
        <div style="display:flex; align-items:center;">
            <span class="ai-badge">AI</span>
            <h4>AI-like behaviour detected</h4>
        </div>
        <p id="ai-alert-text">We detected activity that looks automated. Click Verify to confirm you are human.</p>
        <div class="ai-actions">
            <button class="ai-btn dismiss" id="ai-dismiss">Not Human</button>
            <button class="ai-btn verify" id="ai-verify">Verify</button>
        </div>
    </div>

    <script>
        (function () {
            // cookie helpers
            function setCookie(name, value, days) {
                var d = new Date(); d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = name + "=" + encodeURIComponent(value) + ";path=/;expires=" + d.toUTCString();
            }
            function getCookie(name) {
                var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
                return v ? decodeURIComponent(v.pop()) : null;
            }

            // collector state
            window.__pageLoadTs = Date.now();
            window.__audioPlayTs = null;
            window.__firstMouseMove = null;
            window.__mouseSamplesCount = 0;
            window.__mouseStart = null;
            window.__mouseLastTs = null;
            window.__mouseSumSpeed = 0;
            window.__focusChanges = 0;
            window.__playEvents = 0;
            window.__aiTriggered = false; // set true when AI run detected (see below)
            const audio = document.getElementById('audio-player');

            // mouse sampling (lightweight)
            document.addEventListener('mousemove', function (e) {
                var t = Date.now() - window.__pageLoadTs;
                if (!window.__firstMouseMove) window.__firstMouseMove = t;
                window.__mouseSamplesCount++;
                if (!window.__mouseStart) window.__mouseStart = t;
                if (window.__mouseLastTs) {
                    var dt = (t - window.__mouseLastTs) || 1;
                    var last = window.__lastMousePos || [e.clientX, e.clientY];
                    var dx = e.clientX - last[0], dy = e.clientY - last[1];
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    window.__mouseSumSpeed += dist / dt;
                }
                window.__lastMousePos = [e.clientX, e.clientY];
                window.__mouseLastTs = t;
            }, { passive: true });

            // audio play
            if (audio) audio.addEventListener('play', function () {
                if (!window.__audioPlayTs) window.__audioPlayTs = Date.now() - window.__pageLoadTs;
                window.__playEvents++;
            });

            // visibility
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) window.__focusChanges++;
            });

            // main send function
            function sendSignalAndMaybeAlert(eventLabel) {
                if (getCookie('hum_verified') === '1') return; // user already verified
                var now = Date.now();
                var payload = {
                    page_load_ts: window.__pageLoadTs,
                    audio_play_delay_ms: window.__audioPlayTs !== null ? window.__audioPlayTs : -1,
                    first_mouse_move_ms: window.__firstMouseMove !== null ? window.__firstMouseMove : -1,
                    time_to_submit_ms: now - window.__pageLoadTs,
                    mouse_samples_count: window.__mouseSamplesCount,
                    mouse_duration_ms: window.__mouseStart ? ((window.__mouseLastTs || 0) - window.__mouseStart) : 0,
                    mouse_avg_speed: window.__mouseSamplesCount > 0 ? (window.__mouseSumSpeed / window.__mouseSamplesCount) : 0,
                    focus_changes: window.__focusChanges,
                    play_events: window.__playEvents,
                    via_ai_flag: !!window.__aiTriggered,
                    event: eventLabel || ''
                };

                fetch('/bot_signal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    credentials: 'same-origin'
                })
                    .then(r => r.json())
                    .then(function (resp) {
                        console.log('bot_signal resp:', resp);

                        if (resp && resp.suspect) {
                            if (getCookie('hum_verified') !== '1') {
                                // use defender toast instead of result modal
                                if (window.showAIAlert) {
                                    window.showAIAlert();
                                }
                            } else {
                                console.log('hum_verified cookie present; skipping defender popup');
                            }
                        }

                        else {
                            console.log('server did not mark suspect (score:', resp.score, ')');
                        }
                    })
                    .catch(function (err) {
                        console.warn('bot_signal failed', err);
                    });

            }

            // hook into important moments:
            if (audio) audio.addEventListener('play', function () { sendSignalAndMaybeAlert('audio_play'); });
            var form = document.getElementById('captcha-form');
            if (form) {
                form.addEventListener('submit', function (e) {
                    setTimeout(function () { sendSignalAndMaybeAlert('submit'); }, 100);
                });
            }

            // Expose for manual trigger from other code (AI handler)
            window.sendSignalAndMaybeAlert = sendSignalAndMaybeAlert;

            // popup buttons
            document.getElementById('ai-verify').addEventListener('click', function () {
                setCookie('hum_verified', '1', 30);
                document.getElementById('ai-alert').style.display = 'none';
            });
            document.getElementById('ai-dismiss').addEventListener('click', function () {
                document.getElementById('ai-alert').style.display = 'none';
            });

        })();
    </script>
    <!-- ===== end defender block ===== -->


</body>

</html>